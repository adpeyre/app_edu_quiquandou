<?php

namespace SchoolBundle\Repository;
use SchoolBundle\Entity\User;
use SchoolBundle\Entity\ClassAssignment;
/**
 * ClassRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ClassroomRepository extends \Doctrine\ORM\EntityRepository
{

    public function getUsersByClass($class_id){
         $qb = $this->createQueryBuilder('c')
            ->select('u') 
            ->addSelect('c')                   
            ->leftJoin('SchoolBundle\Entity\ClassAssignment','ca','WITH','ca.class=c.id')
            ->leftJoin('SchoolBundle\Entity\User','u','WITH','ca.user = u.id')
            ->where('ca.class=?1')
            ->setParameter('1',$class_id);

         $result =  $qb
            ->getQuery()
            ->getResult(); 

        //echo'<pre>';print_r($result);echo'</pre>';

        return $result; 
    }

    /*

        SELECT c.* FROM classroom c
        LEFT JOIN ClassAssignment ca
        ON c.id = ca.class AND ca.user_id = ?
        ORDER BY c.year DESC



        */


    public function getClassesAffected(User $user){
        

    
        $qb = $this->createQueryBuilder('c')       
        ->select('c')
        ->addSelect('c.id','(ca.id) AS ca_id','(ca.class) AS ca_class','(ca.user) AS ca_user')       
        ->leftJoin('SchoolBundle:ClassAssignment','ca','WITH','c.id = ca.class AND ca.user=?1 ')
        ->setParameter(1, $user)
        ->orderBy('c.year','DESC');

        $result =  $qb
            ->getQuery()
            ->getResult();  

        $finalResult =array();

        foreach($result as $r){
            
            
            $finalResult[ $r['id'] ] = array(
                'classroom' => $r[0],
                'class_assignment' => (empty($r['ca_id'])) ? null : (new ClassAssignment())->setId($r['ca_id'])->setClass($r['ca_class'])->setUser($r['ca_user'])
            );
            
        }

       
        return $finalResult;
    }
   
}
